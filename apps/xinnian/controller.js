'use strict';

define(['zepto', 'anim', './../../editor/painter', './../../render/renderer', './../../brush/brushes', './../../wx/jweixin-1.0.0'], function($, ko, Painter, Renderer, Brushes, wx) {

    var clickEvent = 'touchstart';
    var body = $('body');

    var mock = {
        "title":'糊涂祝大家',
        "desc": "糊涂给各位粉丝拜大年了",
        "texts": "糊涂给各位粉丝拜大年，祝大家在新的一年里,大吉大利，记得多用多玩：",
        "words": [{
            "type": "frame",
            "c": [{
                "type": "group",
                "c": [{
                    "type": "curve",
                    "c": [
                        [0.28847222222222224, 0.4577777777777778, 1.3229999542236328],
                        [0.3329166666666667, 0.4577777777777778, 1.3409998416900635],
                        [0.3640277777777778, 0.4577777777777778, 1.3569998741149902],
                        [0.39958333333333335, 0.4577777777777778, 1.375],
                        [0.4440277777777778, 0.4577777777777778, 1.3919999599456787],
                        [0.4840277777777778, 0.4533333333333333, 1.4189999103546143],
                        [0.5284722222222222, 0.4177777777777778, 1.4259998798370361],
                        [0.5684722222222223, 0.39555555555555555, 1.4429998397827148],
                        [0.5906944444444444, 0.37777777777777777, 1.4659998416900635],
                        [0.6173611111111111, 0.35555555555555557, 1.4779999256134033],
                        [0.6306944444444444, 0.3466666666666667, 1.49399995803833],
                        [0.6395833333333333, 0.3466666666666667, 1.5109999179840088],
                        [0.6395833333333333, 0.3466666666666667, 1.617999792098999]
                    ],
                    "i": 0
                }],
                "i": 1,
                "id": "group2015,2,18,10,530.0028",
                "brushType": "ink"
            }],
            "i": 0,
            "ptN": null
        }, {
            "type": "frame",
            "c": [{
                "type": "group",
                "c": [{
                    "type": "curve",
                    "c": [
                        [0.22625, 0.35555555555555557, 3.9179999828338623],
                        [0.22625, 0.3688888888888889, 3.934000015258789],
                        [0.22625, 0.39555555555555555, 3.9539999961853027],
                        [0.22625, 0.4266666666666667, 3.9679999351501465],
                        [0.22625, 0.4533333333333333, 3.9860000610351562],
                        [0.22625, 0.47555555555555556, 4.013000011444092],
                        [0.22625, 0.49333333333333335, 4.019999980926514],
                        [0.22625, 0.52, 4.039000034332275],
                        [0.2351388888888889, 0.5377777777777778, 4.055000066757202],
                        [0.23958333333333334, 0.5511111111111111, 4.071000099182129],
                        [0.23958333333333334, 0.5555555555555556, 4.088000059127808]
                    ],
                    "i": 0
                }, {
                    "type": "curve",
                    "c": [
                        [0.24847222222222223, 0.32, 4.703999996185303],
                        [0.2573611111111111, 0.32, 4.7209999561309814],
                        [0.26625, 0.3111111111111111, 4.73799991607666],
                        [0.2751388888888889, 0.3111111111111111, 4.755000114440918],
                        [0.27958333333333335, 0.3111111111111111, 4.831000089645386],
                        [0.29736111111111113, 0.3111111111111111, 4.8480000495910645],
                        [0.31069444444444444, 0.3111111111111111, 4.86899995803833],
                        [0.3373611111111111, 0.30666666666666664, 4.881999969482422],
                        [0.3506944444444444, 0.3022222222222222, 4.908999919891357],
                        [0.3595833333333333, 0.3022222222222222, 4.916000127792358],
                        [0.3640277777777778, 0.3022222222222222, 4.934999942779541],
                        [0.3684722222222222, 0.3022222222222222, 4.950999975204468],
                        [0.3729166666666667, 0.3022222222222222, 4.992000102996826],
                        [0.3729166666666667, 0.3022222222222222, 5.016000032424927],
                        [0.3773611111111111, 0.30666666666666664, 5.0329999923706055],
                        [0.38625, 0.3111111111111111, 5.05400013923645],
                        [0.39958333333333335, 0.31555555555555553, 5.068000078201294],
                        [0.40847222222222224, 0.32, 5.085000038146973],
                        [0.41291666666666665, 0.3244444444444444, 5.102999925613403],
                        [0.4173611111111111, 0.3288888888888889, 5.120000123977661],
                        [0.4173611111111111, 0.3377777777777778, 5.13700008392334],
                        [0.42180555555555554, 0.3511111111111111, 5.1540000438690186],
                        [0.4351388888888889, 0.37333333333333335, 5.171000003814697],
                        [0.4440277777777778, 0.4, 5.187999963760376],
                        [0.4484722222222222, 0.4311111111111111, 5.204999923706055],
                        [0.4529166666666667, 0.4622222222222222, 5.2220001220703125],
                        [0.4573611111111111, 0.4888888888888889, 5.239000082015991],
                        [0.4618055555555556, 0.5155555555555555, 5.256999969482422],
                        [0.46625, 0.5333333333333333, 5.273999929428101],
                        [0.47069444444444447, 0.5511111111111111, 5.291000127792358],
                        [0.47069444444444447, 0.5644444444444444, 5.306999921798706],
                        [0.4751388888888889, 0.5777777777777777, 5.324000120162964],
                        [0.4751388888888889, 0.5822222222222222, 5.3420000076293945],
                        [0.4751388888888889, 0.5866666666666667, 5.358999967575073],
                        [0.47069444444444447, 0.5866666666666667, 5.482000112533569]
                    ],
                    "i": 1
                }, {
                    "type": "curve",
                    "c": [
                        [0.3373611111111111, 0.16444444444444445, 6.140000104904175],
                        [0.3373611111111111, 0.19555555555555557, 6.1570000648498535],
                        [0.3373611111111111, 0.25333333333333335, 6.174000024795532],
                        [0.3373611111111111, 0.3111111111111111, 6.190999984741211],
                        [0.3373611111111111, 0.3466666666666667, 6.209000110626221],
                        [0.3373611111111111, 0.39555555555555555, 6.226999998092651],
                        [0.3373611111111111, 0.4533333333333333, 6.24399995803833],
                        [0.3373611111111111, 0.5022222222222222, 6.259999990463257],
                        [0.3373611111111111, 0.5377777777777778, 6.283999919891357],
                        [0.3373611111111111, 0.5911111111111111, 6.294000148773193],
                        [0.3373611111111111, 0.6311111111111111, 6.311000108718872],
                        [0.3373611111111111, 0.6711111111111111, 6.327000141143799],
                        [0.3373611111111111, 0.7244444444444444, 6.3450000286102295],
                        [0.3373611111111111, 0.7555555555555555, 6.361999988555908],
                        [0.34180555555555553, 0.7911111111111111, 6.378999948501587],
                        [0.34180555555555553, 0.8177777777777778, 6.396000146865845],
                        [0.34180555555555553, 0.8266666666666667, 6.414000034332275],
                        [0.34180555555555553, 0.8355555555555556, 6.434999942779541],
                        [0.34625, 0.8355555555555556, 6.447000026702881],
                        [0.34625, 0.84, 6.465000152587891],
                        [0.34625, 0.8355555555555556, 6.5320000648498535]
                    ],
                    "i": 2
                }, {
                    "type": "curve",
                    "c": [
                        [0.5329166666666667, 0.27555555555555555, 7.302000045776367],
                        [0.5329166666666667, 0.32, 7.318000078201294],
                        [0.5329166666666667, 0.36, 7.340000152587891],
                        [0.5329166666666667, 0.40444444444444444, 7.352999925613403],
                        [0.5329166666666667, 0.44, 7.371000051498413],
                        [0.5329166666666667, 0.4888888888888889, 7.38700008392334],
                        [0.5329166666666667, 0.5333333333333333, 7.4040000438690186],
                        [0.5329166666666667, 0.5644444444444444, 7.421000003814697],
                        [0.5329166666666667, 0.5911111111111111, 7.437999963760376],
                        [0.5329166666666667, 0.6088888888888889, 7.4679999351501465],
                        [0.5329166666666667, 0.6311111111111111, 7.4709999561309814],
                        [0.5329166666666667, 0.64, 7.48799991607666],
                        [0.5284722222222222, 0.64, 7.505000114440918],
                        [0.5284722222222222, 0.6311111111111111, 7.605999946594238]
                    ],
                    "i": 3
                }, {
                    "type": "curve",
                    "c": [
                        [0.54625, 0.26222222222222225, 8.348000049591064],
                        [0.5773611111111111, 0.24888888888888888, 8.364000082015991],
                        [0.5995833333333334, 0.24444444444444444, 8.38100004196167],
                        [0.6129166666666667, 0.24444444444444444, 8.401999950408936],
                        [0.6173611111111111, 0.24, 8.416000127792358],
                        [0.62625, 0.24, 8.437000036239624],
                        [0.6306944444444444, 0.24, 8.509999990463257],
                        [0.6351388888888889, 0.24, 8.532999992370605],
                        [0.6395833333333333, 0.24, 8.55299997329712],
                        [0.6440277777777778, 0.24, 8.568000078201294],
                        [0.6484722222222222, 0.24, 8.585999965667725],
                        [0.6484722222222222, 0.24444444444444444, 8.61299991607666],
                        [0.6529166666666667, 0.26222222222222225, 8.630000114440918],
                        [0.6529166666666667, 0.29333333333333333, 8.647000074386597],
                        [0.6573611111111111, 0.3511111111111111, 8.664000034332275],
                        [0.6573611111111111, 0.41333333333333333, 8.680999994277954],
                        [0.66625, 0.47555555555555556, 8.697999954223633],
                        [0.6751388888888888, 0.5288888888888889, 8.71500015258789],
                        [0.6795833333333333, 0.5777777777777777, 8.730999946594238],
                        [0.6795833333333333, 0.6133333333333333, 8.748000144958496],
                        [0.6884722222222223, 0.64, 8.766000032424927],
                        [0.6973611111111111, 0.6666666666666666, 8.78600001335144],
                        [0.7151388888888889, 0.6888888888888889, 8.80299997329712],
                        [0.7284722222222222, 0.7066666666666667, 8.819999933242798],
                        [0.7418055555555556, 0.7244444444444444, 8.838000059127808],
                        [0.7506944444444444, 0.7333333333333333, 8.850000143051147],
                        [0.7729166666666667, 0.7422222222222222, 8.873000144958496],
                        [0.8129166666666666, 0.7422222222222222, 8.884000062942505],
                        [0.8706944444444444, 0.72, 8.90499997138977],
                        [0.9240277777777778, 0.68, 8.920000076293945],
                        [0.9595833333333333, 0.6488888888888888, 8.934999942779541],
                        [0.9818055555555556, 0.6311111111111111, 8.953999996185303],
                        [0.9951388888888889, 0.6133333333333333, 8.972000122070312],
                        [1.0040277777777777, 0.6088888888888889, 8.989000082015991]
                    ],
                    "i": 4
                }, {
                    "type": "curve",
                    "c": [
                        [0.5151388888888889, 0.4533333333333333, 9.670000076293945],
                        [0.5284722222222222, 0.4533333333333333, 9.686000108718872],
                        [0.5329166666666667, 0.4533333333333333, 9.70799994468689],
                        [0.5373611111111111, 0.4533333333333333, 9.723000049591064],
                        [0.5418055555555555, 0.4533333333333333, 9.806999921798706],
                        [0.5595833333333333, 0.4533333333333333, 9.827000141143799],
                        [0.5818055555555556, 0.4533333333333333, 9.84000015258789],
                        [0.5951388888888889, 0.4533333333333333, 9.85700011253357],
                        [0.6040277777777778, 0.4533333333333333, 9.874000072479248],
                        [0.6084722222222222, 0.4533333333333333, 9.891000032424927]
                    ],
                    "i": 5
                }],
                "i": 1,
                "id": "group2015,2,18,10,530.8270",
                "brushType": "ink"
            }],
            "i": 0,
            "ptN": null
        }, {
            "type": "frame",
            "c": [{
                "type": "group",
                "c": [{
                    "type": "curve",
                    "c": [
                        [0.24847222222222223, 0.1688888888888889, 11.444999933242798],
                        [0.24847222222222223, 0.20444444444444446, 11.461999893188477],
                        [0.24847222222222223, 0.27111111111111114, 11.478999853134155],
                        [0.24847222222222223, 0.3466666666666667, 11.504999876022339],
                        [0.24847222222222223, 0.4177777777777778, 11.51799988746643],
                        [0.24847222222222223, 0.5111111111111111, 11.533999919891357],
                        [0.24847222222222223, 0.6088888888888889, 11.55299997329712],
                        [0.24847222222222223, 0.6755555555555556, 11.566999912261963],
                        [0.24847222222222223, 0.7244444444444444, 11.585000038146973],
                        [0.24847222222222223, 0.7555555555555555, 11.601999998092651],
                        [0.24847222222222223, 0.76, 11.629999876022339],
                        [0.24847222222222223, 0.7644444444444445, 11.63099980354309]
                    ],
                    "i": 0
                }, {
                    "type": "curve",
                    "c": [
                        [0.28847222222222224, 0.25333333333333335, 12.402999877929688],
                        [0.3373611111111111, 0.2311111111111111, 12.419999837875366],
                        [0.39069444444444446, 0.20444444444444446, 12.437999963760376],
                        [0.42180555555555554, 0.18666666666666668, 12.454999923706055],
                        [0.4618055555555556, 0.17333333333333334, 12.472999811172485],
                        [0.4751388888888889, 0.16444444444444445, 12.488999843597412],
                        [0.4884722222222222, 0.15555555555555556, 12.506999969482422],
                        [0.4973611111111111, 0.1511111111111111, 12.523000001907349],
                        [0.5906944444444444, 0.10222222222222223, 12.628000020980835],
                        [0.6040277777777778, 0.09777777777777778, 12.64299988746643],
                        [0.6173611111111111, 0.09333333333333334, 12.664000034332275],
                        [0.62625, 0.09333333333333334, 12.67799997329712],
                        [0.6306944444444444, 0.09333333333333334, 12.694999933242798],
                        [0.6351388888888889, 0.09333333333333334, 12.712999820709229],
                        [0.6395833333333333, 0.09333333333333334, 12.746999979019165],
                        [0.6395833333333333, 0.09333333333333334, 12.771999835968018],
                        [0.6440277777777778, 0.09333333333333334, 12.789999961853027],
                        [0.6484722222222222, 0.09777777777777778, 12.806999921798706],
                        [0.6529166666666667, 0.09777777777777778, 12.824999809265137],
                        [0.6529166666666667, 0.10222222222222223, 12.842999935150146],
                        [0.6573611111111111, 0.1111111111111111, 12.858999967575073],
                        [0.6573611111111111, 0.12, 12.875999927520752],
                        [0.6573611111111111, 0.14222222222222222, 12.893999814987183],
                        [0.6573611111111111, 0.17333333333333334, 12.91100001335144],
                        [0.6573611111111111, 0.2, 12.92799997329712],
                        [0.6573611111111111, 0.22666666666666666, 12.94599986076355],
                        [0.6573611111111111, 0.26222222222222225, 12.961999893188477],
                        [0.6440277777777778, 0.3022222222222222, 12.98199987411499],
                        [0.6306944444444444, 0.3422222222222222, 13],
                        [0.6218055555555555, 0.37777777777777777, 13.016999959945679],
                        [0.6129166666666667, 0.4088888888888889, 13.032999992370605],
                        [0.6084722222222222, 0.4444444444444444, 13.04699993133545],
                        [0.6040277777777778, 0.47555555555555556, 13.067999839782715],
                        [0.5995833333333334, 0.5022222222222222, 13.083999872207642],
                        [0.5951388888888889, 0.5333333333333333, 13.101999998092651],
                        [0.5951388888888889, 0.5555555555555556, 13.118000030517578],
                        [0.5951388888888889, 0.5777777777777777, 13.133999824523926],
                        [0.5951388888888889, 0.6, 13.149999856948853],
                        [0.5951388888888889, 0.6222222222222222, 13.168999910354614],
                        [0.6040277777777778, 0.6488888888888888, 13.184000015258789],
                        [0.6129166666666667, 0.6666666666666666, 13.20199990272522],
                        [0.6218055555555555, 0.6844444444444444, 13.217999935150146],
                        [0.6351388888888889, 0.6977777777777778, 13.234999895095825],
                        [0.6529166666666667, 0.7022222222222222, 13.253000020980835],
                        [0.6840277777777778, 0.7111111111111111, 13.268999814987183],
                        [0.7151388888888889, 0.7155555555555555, 13.28600001335144],
                        [0.7418055555555556, 0.72, 13.303999900817871],
                        [0.7684722222222222, 0.7244444444444444, 13.32200002670288],
                        [0.78625, 0.7244444444444444, 13.33899998664856],
                        [0.7995833333333333, 0.7244444444444444, 13.355999946594238],
                        [0.8173611111111111, 0.72, 13.371999979019165],
                        [0.8351388888888889, 0.7111111111111111, 13.388999938964844],
                        [0.8484722222222222, 0.6977777777777778, 13.405999898910522],
                        [0.8618055555555556, 0.6888888888888889, 13.422999858856201],
                        [0.8706944444444444, 0.68, 13.43999981880188],
                        [0.8795833333333334, 0.6755555555555556, 13.457000017166138],
                        [0.8795833333333334, 0.6711111111111111, 13.473999977111816],
                        [0.8840277777777777, 0.6711111111111111, 13.491999864578247],
                        [0.8840277777777777, 0.6666666666666666, 13.508999824523926],
                        [0.8840277777777777, 0.6577777777777778, 13.580999851226807],
                        [0.8795833333333334, 0.6355555555555555, 13.598999977111816],
                        [0.8529166666666667, 0.5555555555555556, 13.616999864578247],
                        [0.8218055555555556, 0.4711111111111111, 13.633999824523926],
                        [0.7906944444444445, 0.39555555555555555, 13.649999856948853],
                        [0.7773611111111111, 0.3511111111111111, 13.671000003814697]
                    ],
                    "i": 1
                }, {
                    "type": "curve",
                    "c": [
                        [0.5284722222222222, 0.28, 14.40499997138977],
                        [0.5195833333333333, 0.28, 14.422999858856201],
                        [0.50625, 0.28, 14.438999891281128],
                        [0.4973611111111111, 0.28, 14.455999851226807],
                        [0.49291666666666667, 0.28, 14.473999977111816],
                        [0.4884722222222222, 0.28, 14.53499984741211],
                        [0.4795833333333333, 0.28444444444444444, 14.55299997329712],
                        [0.47069444444444447, 0.29333333333333333, 14.57200002670288],
                        [0.46625, 0.29777777777777775, 14.585999965667725],
                        [0.4440277777777778, 0.31555555555555553, 14.602999925613403],
                        [0.4351388888888889, 0.3244444444444444, 14.619999885559082],
                        [0.43069444444444444, 0.3377777777777778, 14.63699984550476],
                        [0.42625, 0.3422222222222222, 14.65399980545044],
                        [0.42625, 0.3422222222222222, 14.67199993133545],
                        [0.42625, 0.3466666666666667, 14.687999963760376],
                        [0.42180555555555554, 0.3466666666666667, 14.705999851226807],
                        [0.40847222222222224, 0.36, 14.721999883651733],
                        [0.39069444444444446, 0.38222222222222224, 14.738999843597412],
                        [0.3729166666666667, 0.4, 14.75599980354309],
                        [0.3551388888888889, 0.4177777777777778, 14.7739999294281],
                        [0.34180555555555553, 0.4266666666666667, 14.79099988937378],
                        [0.3373611111111111, 0.4311111111111111, 14.807999849319458],
                        [0.3373611111111111, 0.43555555555555553, 14.825999975204468],
                        [0.3329166666666667, 0.43555555555555553, 14.902999877929688],
                        [0.3329166666666667, 0.44, 14.919999837875366],
                        [0.3329166666666667, 0.4444444444444444, 15.006999969482422]
                    ],
                    "i": 2
                }, {
                    "type": "curve",
                    "c": [
                        [0.3329166666666667, 0.30666666666666664, 15.792999982833862],
                        [0.3951388888888889, 0.31555555555555553, 15.809999942779541],
                        [0.4973611111111111, 0.35555555555555557, 15.82699990272522],
                        [0.5595833333333333, 0.38222222222222224, 15.843999862670898],
                        [0.6040277777777778, 0.4, 15.860999822616577],
                        [0.6395833333333333, 0.41333333333333333, 15.878000020980835],
                        [0.6618055555555555, 0.4222222222222222, 15.895999908447266],
                        [0.6706944444444445, 0.4266666666666667, 15.912999868392944]
                    ],
                    "i": 3
                }],
                "i": 1,
                "id": "group2015,2,18,10,530.2863",
                "brushType": "ink"
            }],
            "i": 0,
            "ptN": null
        }, {
            "type": "frame",
            "c": [{
                "type": "group",
                "c": [{
                    "type": "curve",
                    "c": [
                        [0.24847222222222223, 0.3111111111111111, 17.500999927520752],
                        [0.24847222222222223, 0.31555555555555553, 17.628999948501587],
                        [0.24847222222222223, 0.3511111111111111, 17.647000074386597],
                        [0.24847222222222223, 0.4, 17.66700005531311],
                        [0.24847222222222223, 0.44, 17.694999933242798],
                        [0.24847222222222223, 0.5022222222222222, 17.69700002670288],
                        [0.24847222222222223, 0.5688888888888889, 17.716000080108643],
                        [0.24847222222222223, 0.6222222222222222, 17.741999864578247],
                        [0.24847222222222223, 0.6488888888888888, 17.750999927520752],
                        [0.24847222222222223, 0.6711111111111111, 17.76699995994568],
                        [0.24847222222222223, 0.6755555555555556, 17.783999919891357]
                    ],
                    "i": 0
                }, {
                    "type": "curve",
                    "c": [
                        [0.2529166666666667, 0.12, 18.438999891281128],
                        [0.2573611111111111, 0.1288888888888889, 18.456000089645386],
                        [0.26625, 0.14666666666666667, 18.473000049591064],
                        [0.28847222222222224, 0.1688888888888889, 18.490000009536743],
                        [0.30625, 0.19111111111111112, 18.506999969482422],
                        [0.31958333333333333, 0.2088888888888889, 18.524999856948853],
                        [0.3284722222222222, 0.22666666666666666, 18.54200005531311],
                        [0.3373611111111111, 0.24444444444444444, 18.566999912261963],
                        [0.34625, 0.27111111111111114, 18.575999975204468],
                        [0.3551388888888889, 0.3022222222222222, 18.592999935150146],
                        [0.3684722222222222, 0.3377777777777778, 18.621000051498413],
                        [0.3773611111111111, 0.37333333333333335, 18.628000020980835],
                        [0.38625, 0.4177777777777778, 18.64400005340576],
                        [0.39069444444444446, 0.4622222222222222, 18.66100001335144],
                        [0.40402777777777776, 0.52, 18.67799997329712],
                        [0.40847222222222224, 0.5733333333333334, 18.698999881744385],
                        [0.40847222222222224, 0.6222222222222222, 18.716000080108643],
                        [0.40847222222222224, 0.6666666666666666, 18.73199987411499],
                        [0.40847222222222224, 0.6844444444444444, 18.750999927520752],
                        [0.40847222222222224, 0.6933333333333334, 18.766000032424927],
                        [0.40847222222222224, 0.6977777777777778, 18.782999992370605],
                        [0.40847222222222224, 0.7022222222222222, 18.799000024795532]
                    ],
                    "i": 1
                }, {
                    "type": "curve",
                    "c": [
                        [0.47069444444444447, 0.3466666666666667, 19.625],
                        [0.47069444444444447, 0.40444444444444444, 19.64199995994568],
                        [0.47069444444444447, 0.48444444444444446, 19.658999919891357],
                        [0.47069444444444447, 0.5777777777777777, 19.675999879837036],
                        [0.47069444444444447, 0.6622222222222223, 19.694000005722046],
                        [0.47069444444444447, 0.7111111111111111, 19.710999965667725],
                        [0.47069444444444447, 0.7466666666666667, 19.728999853134155],
                        [0.47069444444444447, 0.7822222222222223, 19.776999950408936],
                        [0.47069444444444447, 0.7866666666666666, 19.77999997138977],
                        [0.47069444444444447, 0.7911111111111111, 19.800999879837036],
                        [0.47069444444444447, 0.7955555555555556, 19.813999891281128],
                        [0.47069444444444447, 0.7911111111111111, 19.88100004196167]
                    ],
                    "i": 2
                }, {
                    "type": "curve",
                    "c": [
                        [0.5418055555555555, 0.1688888888888889, 20.85599994659424],
                        [0.5684722222222223, 0.1688888888888889, 20.875],
                        [0.6129166666666667, 0.16, 20.888999938964844],
                        [0.6395833333333333, 0.15555555555555556, 20.905999898910522],
                        [0.6529166666666667, 0.15555555555555556, 20.9229998588562],
                        [0.6618055555555555, 0.15555555555555556, 20.941999912261963],
                        [0.66625, 0.15555555555555556, 20.957000017166138],
                        [0.66625, 0.15555555555555556, 21.18499994277954],
                        [0.66625, 0.16444444444444445, 21.20199990272522],
                        [0.6618055555555555, 0.19555555555555557, 21.2189998626709],
                        [0.6395833333333333, 0.2311111111111111, 21.23799991607666],
                        [0.6129166666666667, 0.26222222222222225, 21.253999948501587],
                        [0.58625, 0.30666666666666664, 21.270999908447266],
                        [0.5640277777777778, 0.3333333333333333, 21.287999868392944],
                        [0.5506944444444445, 0.3511111111111111, 21.305000066757202],
                        [0.54625, 0.35555555555555557, 21.32099986076355],
                        [0.5418055555555555, 0.36, 21.338000059127808],
                        [0.5373611111111111, 0.36, 21.355000019073486],
                        [0.5373611111111111, 0.3688888888888889, 21.560999870300293],
                        [0.5418055555555555, 0.38666666666666666, 21.57800006866455],
                        [0.5551388888888888, 0.4222222222222222, 21.59500002861023],
                        [0.5684722222222223, 0.4666666666666667, 21.611999988555908],
                        [0.5906944444444444, 0.5244444444444445, 21.628999948501587],
                        [0.5995833333333334, 0.5866666666666667, 21.6489999294281],
                        [0.6084722222222222, 0.6444444444444445, 21.664000034332275],
                        [0.6129166666666667, 0.6844444444444444, 21.68499994277954],
                        [0.6129166666666667, 0.7155555555555555, 21.70199990272522],
                        [0.6129166666666667, 0.7288888888888889, 21.7189998626709],
                        [0.6129166666666667, 0.7333333333333333, 21.733999967575073],
                        [0.6129166666666667, 0.7377777777777778, 21.75],
                        [0.6129166666666667, 0.7333333333333333, 21.816999912261963]
                    ],
                    "i": 3
                }, {
                    "type": "curve",
                    "c": [
                        [0.5729166666666666, 0.35555555555555557, 22.941999912261963],
                        [0.6129166666666667, 0.3466666666666667, 22.95799994468689],
                        [0.6440277777777778, 0.3377777777777778, 22.97499990463257],
                        [0.6706944444444445, 0.3288888888888889, 22.993000030517578],
                        [0.6929166666666666, 0.3244444444444444, 23.009999990463257],
                        [0.7151388888888889, 0.3244444444444444, 23.026999950408936],
                        [0.7240277777777778, 0.3244444444444444, 23.045000076293945],
                        [0.7284722222222222, 0.3244444444444444, 23.108999967575073],
                        [0.7373611111111111, 0.3244444444444444, 23.125999927520752],
                        [0.7551388888888889, 0.32, 23.14299988746643],
                        [0.7684722222222222, 0.32, 23.16000008583069],
                        [0.7773611111111111, 0.31555555555555553, 23.177000045776367],
                        [0.7818055555555555, 0.31555555555555553, 23.194999933242798],
                        [0.78625, 0.31555555555555553, 23.21499991416931],
                        [0.7906944444444445, 0.31555555555555553, 23.389999866485596],
                        [0.7951388888888888, 0.31555555555555553, 23.437999963760376],
                        [0.7951388888888888, 0.32, 23.477999925613403],
                        [0.7951388888888888, 0.3333333333333333, 23.49399995803833],
                        [0.7951388888888888, 0.36, 23.51099991798401],
                        [0.7951388888888888, 0.39555555555555555, 23.527999877929688],
                        [0.7951388888888888, 0.43555555555555553, 23.545000076293945],
                        [0.7951388888888888, 0.4622222222222222, 23.562999963760376],
                        [0.7951388888888888, 0.49777777777777776, 23.579999923706055],
                        [0.7951388888888888, 0.5288888888888889, 23.6010000705719],
                        [0.7951388888888888, 0.5555555555555556, 23.618000030517578],
                        [0.7951388888888888, 0.5777777777777777, 23.63599991798401],
                        [0.7951388888888888, 0.6, 23.64800000190735],
                        [0.7951388888888888, 0.6088888888888889, 23.670000076293945],
                        [0.7951388888888888, 0.6177777777777778, 23.68499994277954]
                    ],
                    "i": 4
                }, {
                    "type": "curve",
                    "c": [
                        [0.6973611111111111, 0.5066666666666667, 24.287999868392944],
                        [0.6973611111111111, 0.5333333333333333, 24.30399990081787],
                        [0.6973611111111111, 0.5555555555555556, 24.32099986076355],
                        [0.6973611111111111, 0.5955555555555555, 24.338000059127808],
                        [0.6973611111111111, 0.6266666666666667, 24.355000019073486],
                        [0.6973611111111111, 0.6444444444444445, 24.372999906539917],
                        [0.6973611111111111, 0.6577777777777778, 24.389999866485596],
                        [0.6973611111111111, 0.6711111111111111, 24.407000064849854],
                        [0.6973611111111111, 0.6844444444444444, 24.444000005722046],
                        [0.6929166666666666, 0.7022222222222222, 24.460000038146973],
                        [0.6751388888888888, 0.7244444444444444, 24.47699999809265],
                        [0.6529166666666667, 0.7511111111111111, 24.49399995803833],
                        [0.6129166666666667, 0.7822222222222223, 24.51200008392334],
                        [0.58625, 0.8044444444444444, 24.52900004386902],
                        [0.5684722222222223, 0.8133333333333334, 24.546000003814697],
                        [0.5595833333333333, 0.8177777777777778, 24.563999891281128],
                        [0.5506944444444445, 0.8177777777777778, 24.581000089645386],
                        [0.5418055555555555, 0.8177777777777778, 24.60199999809265],
                        [0.5329166666666667, 0.8222222222222222, 24.615999937057495],
                        [0.5284722222222222, 0.8222222222222222, 24.63599991798401]
                    ],
                    "i": 5
                }, {
                    "type": "curve",
                    "c": [
                        [0.7195833333333334, 0.7822222222222223, 25.289999961853027],
                        [0.7284722222222222, 0.7822222222222223, 25.306999921798706],
                        [0.74625, 0.7822222222222223, 25.323999881744385],
                        [0.7551388888888889, 0.7822222222222223, 25.33999991416931],
                        [0.7595833333333334, 0.7822222222222223, 25.35699987411499],
                        [0.7595833333333334, 0.7822222222222223, 25.41000008583069],
                        [0.7640277777777778, 0.7822222222222223, 25.427000045776367],
                        [0.78625, 0.7866666666666666, 25.443000078201294],
                        [0.8084722222222223, 0.7911111111111111, 25.460000038146973],
                        [0.8351388888888889, 0.8, 25.477999925613403],
                        [0.8573611111111111, 0.8088888888888889, 25.494999885559082],
                        [0.8706944444444444, 0.8133333333333334, 25.513000011444092],
                        [0.8795833333333334, 0.8177777777777778, 25.52999997138977],
                        [0.8840277777777777, 0.8177777777777778, 25.5479998588562]
                    ],
                    "i": 6
                }],
                "i": 1,
                "id": "group2015,2,18,10,530.5334",
                "brushType": "ink"
            }],
            "i": 0,
            "ptN": null
        }]
    };

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    function Editor(container) {
        this.container = container;
        this.sceneIndex = 0;
        this.sceneN = 4;
        this.fromid = getQueryString('from');
        // alert(this.fromid+'from');
        this.share();

        var self = this;
        this.start(function(d) {
            var data;
            if (d) {
                data = JSON.parse(d.data);
            } else {
                data = mock;
            }
            self.title = data.title;
            self.desc = data.desc;
            self.init();
            self.displayEvents();
            self.render(data);
        })
    }

    Editor.prototype.init = function() {
        var drawContainer = this.drawContainer = this.container.find('.draw-container');
        this.zhufuContainer = $('.zhufu-container');
        var wordNodes = this.wordNodes = [];
        var brushes = new Brushes();

        // var painter = this.painter =
        // painter.grid();
        var sceneN = this.sceneN;
        for (var k = 0; k < sceneN; k++) {
            var visble = (k === 0) ? 'visible' : 'hidden';
            var painterNode = $('<div class="painter ' + visble + '"></div>');
            drawContainer.append(painterNode);
            wordNodes.push(painterNode);
            var painterNode0 = painterNode[0];
            painterNode0.pIndex = k;
            var painter = painterNode0.painter = new Painter(painterNode, {
                'brushes': brushes
            });
            painter.grid();

        }
        var frameOpt = {
            frameW: $($('.painter')[0]).width(),
            frameH: $($('.painter')[0]).height()
        };
        this.renderer = new Renderer(brushes, frameOpt);

        var askNode = this.askNode = $('<div class="painter hidden" id="dialog"></div>');
        askNode.append(
            '<form> <input name="field＿name" type="type＿name" placeholder="您的名字" class="input" id="myname"></form> ' +
            '<span class="text">给</span><br>' +
            '<form> <input name="field＿name" type="type＿name" placeholder="祝福人名字" class="input" id="hisname"></form> ' +
            '<span class="text">拜年啦，祝在新的一年里：</span><br>' +
            '<form> <input name="field＿name" type="type＿name" placeholder="更多的祝福" class="input"  id="wishes"></form> '
        );
        drawContainer.append(askNode);
    };


    Editor.prototype.displayEvents = function() {
        var self = this;
        $('#restart')
            .text('我也写四字成语，送羊年祝福')
            .off(clickEvent)
            .on(clickEvent, function() {
                self.editor('start');
                self.editEvents();
                var curNode = self.drawContainer.find('.visible')[0];
                curNode.painter.restart();
                curNode.painter.grid();
            });
        $('#back')
            .css({
                opacity: 0
            })
            .off(clickEvent)
            .on(clickEvent, function() {
                self.back();
            });
        $('#forward')
            .css({
                opacity: 0
            })
            .off(clickEvent)
            .on(clickEvent, function() {
                self.forward();
            });
    };

    Editor.prototype.editEvents = function() {
        var self = this;
        $('#restart')
            .off(clickEvent)
            .css({
                opacity: 1
            })
            .text('重写')
            .on(clickEvent, function() {
                var curNode = self.curNode[0] || self.drawContainer.find('.visible')[0];
                curNode.painter.restart();
                curNode.painter.grid();
            });
        $('#back')
            .css({
                opacity: 1
            })
            .off(clickEvent)
            .on(clickEvent, function() {
                self.back();
            });
        $('#forward')
            .text('下一步')
            .css({
                opacity: 1
            })
            .off(clickEvent)
            .on(clickEvent, function() {
                self.forward();
            });
    };

    Editor.prototype.publishEvents = function() {
        var self = this;
        $('#restart')
            .off(clickEvent)
            .css({
                opacity: 0
            })
            // .on(clickEvent, function() {
            //   var curNode = self.curNode[0] || self.drawContainer.find('.visible')[0];
            //   curNode.painter.restart();
            //   curNode.painter.grid();
            // });

        $('#back')
            .css({
                opacity: 1
            })
            .off(clickEvent)
            .on(clickEvent, function() {
                self.back();
            });
        $('#forward')
            .text('右上分享')
            .css({
                opacity: 1
            })
            .off(clickEvent);
    };

    function getId(type) {
        var num = Math.random().toFixed(4);
        var d = new Date();
        var dateStr = [d.getFullYear(), (d.getMonth() + 1), d.getDate(), d.getHours(), d.getMinutes()].join('_');
        return type + dateStr + num;
    }


    Editor.prototype.getData = function() {
        var wordNodes = this.wordNodes;
        var datas = {};
        var words = [];
        for (var k in wordNodes) {
            var wordNode = wordNodes[k];
            var painter = wordNode[0].painter;
            var data = painter.modelDraw.getData();
            words.push(data);
        }
        datas.texts = this.texts;
        datas.words = words;
        if(this.fromName&&this.toName){
            this.title = this.fromName + '祝' + this.toName;
        }else{
            this.title = '涂成语|拜大年';
        }
        return {
            userid: this.dataid,
            data: JSON.stringify(datas),
            drawid: 11,
            title:this.fromName,
            desc:this.texts,
        };
    };


    Editor.prototype.forward = function() {
        var curNode = this.curNode || this.drawContainer.find('.visible');
        var nextNode = curNode.next();

        if (this.sceneIndex < 5) {
            if (this.sceneIndex < 4) {
                curNode.keyAnim('fadeOutUp', {
                    time: 0.4,
                    cb: function() {
                        curNode.removeClass('visible').addClass('hidden');
                    }
                });

                nextNode.removeClass('hidden').addClass('visible');
                nextNode.keyAnim('fadeInUp', {
                    time: 0.4,
                    cb: function() {}
                });
                this.curNode = nextNode;
            }

            if (this.sceneIndex === 4) {
                this.publishEvents()
                var askNode = $('#dialog');
                var inputs = askNode.find('input');
                var from = this.fromName = inputs[0].value || '';
                var to =  this.toName = inputs[1].value || '您';
                var someting = inputs[2].value || '';
                this.texts = from + '给' + to + '拜年啦，祝' + to + '在新的一年里：' + someting;
                this.display('post');
                this.askNode.keyAnim('fadeOutUp', {
                    time: 0.4
                });
            }

            this.sceneIndex = this.sceneIndex + 1;
        }
    };

    Editor.prototype.back = function() {
        var curNode = this.curNode || this.drawContainer.find('.visible');
        var nextNode = curNode.prev();

        if (this.sceneIndex > 0) {
            if (this.sceneIndex < 5) {
                curNode.keyAnim('fadeOutDown', {
                    time: 0.4,
                    cb: function() {
                        curNode.removeClass('visible').addClass('hidden');
                    }
                });

                nextNode.removeClass('hidden').addClass('visible');
                nextNode.keyAnim('fadeInDown', {
                    time: 0.4,
                    cb: function() {}
                });
                this.curNode = nextNode;
            }

            // if (this.sceneIndex === 4) {
            //   this.curNode.keyAnim('fadeInDown',{time:0.5});
            // }

            if (this.sceneIndex === 5) {
                this.editEvents();
                (this.curNode || $('dialog')).keyAnim('fadeInUp', {
                    time: 0.4,
                    delay: 2.04
                });
                this.editor();
            }
            this.sceneIndex = this.sceneIndex - 1;
        }
    };

    Editor.prototype.display = function(type) {
        // this.getData();

        if (type === 'post') {
            this.getOpenid();
            this.postData();
        }
        this.genShare();

        this.zhufuContainer.keyAnim('fadeInLeft', {
            time: 0.4
        }).text(this.texts || '');
        var wordNodes = this.wordNodes;
        var drawContainer = this.drawContainer;
        drawContainer.css({
            'marginTop': '10px',
            'paddingTop': '120%',
            'left': '35%',
            'width': '30%',
        });
        for (var l in wordNodes) {
            var wordNode = wordNodes[l];
            wordNode.css({
                width: '100%',
                height: '25%',
                top: (25 * l) + '%'
            });
            wordNode.find('canvas').css({
                width: '100%',
                height: '100%'
            });
            wordNode.keyAnim('fadeInLeft', {
                time: 0.4,
                delay: 0.2 + 0.25 * l
            });
        }
    };

    Editor.prototype.editor = function(type) {
        var self = this;
        var drawContainer = this.drawContainer;
        this.zhufuContainer.keyAnim('fadeOutLeft', {
            time: 0.5
        });
        setTimeout(function() {
            drawContainer.css({
                'marginTop': '100px',
                'paddingTop': '80%',
                'left': '10%',
                'width': '80%',
            });
        }, 1000);

        if (type === 'start') {
            setTimeout(function() {
                self.wordNodes[0].keyAnim('fadeInUp', {
                    time: 0.5
                });
            }, 1200);
        }

        var wordNodes = this.wordNodes;
        for (var l in wordNodes) {
            var wordNode = wordNodes[l];
            var painter = wordNode[0].painter;
            if (type === 'start') {
                painter.restart();
                painter.grid();
            }

            wordNode.keyAnim('fadeOutRight', {
                time: 0.3,
                delay: 0.2 + 0.1 * l,
                cb: function() {
                    var node = $(this);
                    node.css({
                        width: '100%',
                        height: '100%',
                        top: '0',
                        left: 0
                    });
                    wordNode.find('canvas').css({
                        width: '100%',
                        height: '100%',
                        top: '0',
                        left: 0
                    });
                }
            });
        }
    };

    Editor.prototype.render = function(data) {
        var words = data.words;
        this.texts = data.texts;
        var renderer = this.renderer;
        var wordNodes = this.wordNodes
        for (var k in words) {
            var node = wordNodes[k][0];
            var ctx = node.painter.ctxMainBack;
            var painter = node.painter;
            painter.restart();
            painter.grid();
            var d = words[k];
            renderer.drawDatas(ctx, d);
        }
        this.display();
    }


    Editor.prototype.postData = function() {
        var data = this.getData();
        $.ajax({
            url: 'http://mankattan.mathartworld.com/hotu-api/api/hotu/drawing',
            dataType: 'json',
            type: 'post',
            data: data,
            success: function(d) {
                // cb(d);
            },
            error: function(e) {
                // cb(null);
            }
        });
    };


    Editor.prototype.genShare = function() {
        var self = this;
        wx.ready(function() {
            var title = self.title;
            var picUrl = 'http://open-wedding.qiniudn.com/111.png';
            var desc = self.texts;
            var url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx05125e8c1635642f&redirect_uri=http://mankattan.mathartworld.com/hotu/apps/xinnian?from=' + (self.dataid || self.fromid) + '&response_type=code&scope=snsapi_base&state=123&connect_redirect=1&from=timeline&isappinstalled=0#wechat_redirect'
            var shareObj = {
                title: title,
                link: url,
                imgUrl: picUrl,
                desc: desc,
                success: function() {
                    window.location.href = 'http://mankattan.mathartworld.com/hotu/';
                    // 用户确认分享后执行的回调函数
                },
                cancel: function() {
                    // 用户取消分享后执行的回调函数
                }
            };

            wx.onMenuShareTimeline(shareObj);
            wx.onMenuShareAppMessage(shareObj);
        });
    };

    Editor.prototype.getOpenid = function() {
        this.dataid = Math.floor(Math.random() * 100000);
        // var self = this;
        // this.dataid =
        // $.ajax({
        //   url:'http://mankattan.mathartworld.com/hotu-api/api/weixin/getopenid',
        //   dataType:'json',
        //   type:'get',
        //   data:{code:code},
        //   success:function(d){
        //     self.dataid = d.openid;//+
        //     alert(JSON.stringify(d));
        //     // console.log(d);
        //   },
        //   error:function(d){
        //   }
        // })
    }

    Editor.prototype.share = function() {
        var js_ticket_url = encodeURIComponent(window.location.origin + window.location.pathname + window.location.search);
        $.getJSON('http://mankattan.mathartworld.com/hotu-api/api/weixin/sign?url=' + js_ticket_url,
            function(data, status) {
                data = data || {};
                var config = data.config;
                // config.debug = true;
                wx.config(config);
            });
    };

    Editor.prototype.start = function(cb) { //开始游戏
        this.getDataLast(cb);
    };
    Editor.prototype.getDataLast = function(cb) {
        var self = this;
        $.ajax({
            url: 'http://mankattan.mathartworld.com/hotu-api/api/hotu/drawing',
            dataType: 'json',
            type: 'get',
            data: {
                userid: self.fromid,
                drawid: 11
            },
            success: function(d) {
                if (!d) return cb(null);
                if (d[0] == 500) return cb(null);
                cb(d);
            },
            error: function(e) {
                // alert('eee'+JSON.stringify(e))
                cb(null);
            }
        });
    }
    var editor = new Editor($('.main-container'));

});
